<div class="card history-card">
  <div class="header-section">
    <div class="header-left">
      <h2 class="title">Historique des demandes</h2>
      <p class="subtitle">
        Suivez l'état de vos demandes de souscription SCPI
      </p>
    </div>

    <div class="header-right">
      <label class="filter-label">Filtrer par statut :</label>
      <p-dropdown
        inputId="status-filter"
        [options]="statusOptions"
        [(ngModel)]="selectedStatus"
        (onChange)="filterByStatus()"
        placeholder="Tous les statuts"
        class="status-dropdown"
        [showClear]="true"
        appendTo="body"
      ></p-dropdown>
    </div>
  </div>

  <div class="minimal-stats">
    <span class="minimal-count">{{ filteredHistories.length }}</span>
    <span>demande(s) trouvée(s)</span>
  </div>

  <ng-container *ngIf="filteredHistories.length > 0; else emptyState">
    <p-table
      [value]="filteredHistories"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 20]"
      responsiveLayout="scroll"
      [tableStyle]="{ 'min-width': '100%' }"
      dataKey="investmentId"
      [expandedRowKeys]="expandedRowKeys"
      (onRowExpand)="onRowExpand($event)"
      (onRowCollapse)="onRowCollapse($event)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem"></th>
          <th>Référence</th>
          <th>Date de réception</th>
          <th>Statut</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-history let-expanded="expanded">
        <tr>
          <td>
            <p-button
              type="button"
              pRipple
              [pRowToggler]="history"
              [text]="true"
              severity="secondary"
              [rounded]="true"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
            ></p-button>
          </td>
          <td>{{ history.investmentId }}</td>
          <td>{{ history.creationDate | date: 'dd/MM/yyyy HH:mm' : 'Europe/Paris' }}</td>
          <td>
            <p-tag
              [value]="getStatusLabel(history.status)"
              [severity]="getStatusSeverity(history.status)"
              [style]="getStatusStyle(history.status)"
              icon="{{ getStatusIcon(history.status) }}"
            ></p-tag>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion">
        <tr>
          <td colspan="4">
            <div class="p-4">
              <p-table
                [value]="historyDetails"
                dataKey="id"
                responsiveLayout="scroll"
                [tableStyle]="{ 'min-width': '100%' }"
                *ngIf="historyDetails.length > 0"
              >
                <ng-template pTemplate="header">
        <tr>
          <th>Date</th>
          <th>Statut</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-detail>
        <tr>
          <td>{{ detail.modificationDate | date: 'dd/MM/yyyy HH:mm' : 'Europe/Paris' }}</td>
          <td>
            <p-tag
              [value]="getStatusLabel(detail.status)"
              [severity]="getStatusSeverity(detail.status)"
              [style]="getStatusStyle(detail.status)"
              icon="{{ getStatusIcon(detail.status) }}"
            ></p-tag>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="2">Aucun détail disponible.</td>
        </tr>
      </ng-template>
    </p-table>

    <p *ngIf="!historyDetails" class="text-gray-500 text-sm mt-2">
      Chargement des détails...
    </p>
</div>
</td>
</tr>
</ng-template>
</p-table>
</ng-container>

<ng-template #emptyState>
  <p-message
    severity="info"
    text="Vous n’avez encore effectué aucune demande. "
  ></p-message>
</ng-template>
</div>

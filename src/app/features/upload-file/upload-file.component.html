<div class="kyc-container">
  <div class="kyc-wrapper">
    <ng-container *ngFor="let doc of documents">
      <p-card class="kyc-card" [ngClass]="{'kyc-card--address': doc.key === 'address'}">
        
        <ng-template pTemplate="header">
          <div class="kyc-title">{{ doc.label }}</div>
          <div class="kyc-subtitle">
            <ng-container [ngSwitch]="doc.key">
              <span *ngSwitchCase="'identity'">
                Carte d'identité, passeport ou titre de séjour
              </span>
              <span *ngSwitchCase="'address'">
                Facture d'électricité, de gaz, d'eau ou quittance de loyer (moins de 3 mois)
              </span>
              <span *ngSwitchCase="'tax'">
                Dernier avis d'imposition sur le revenu
              </span>
            </ng-container>
          </div>
        </ng-template>

        <p-fileUpload
          #fileUploadRef
          [name]="doc.key"
          mode="advanced"
          [multiple]="false"
          [showUploadButton]="false"
          [showCancelButton]="false"
          [customUpload]="true"
          (onSelect)="onSelect($event, doc.key)"
          (onClear)="onClear(doc.key)"
          [maxFileSize]="maxFileSize"
          [accept]="accept"
          chooseLabel="Parcourir les fichiers"
          class="kyc-uploader"
        >
          <ng-template pTemplate="content">
            
            <div 
              *ngIf="!files[doc.key]" 
              class="dropzone"
            >
              <div class="dropzone-icon">
                <i class="pi pi-upload"></i>
              </div>
              
              <div class="dropzone-text">
                Glissez-déposez votre document
              </div>
              
              <span class="dropzone-ou">ou</span>
              
              <button
                type="button"
                pButton
                class="p-button-outlined kyc-choose-btn"
                label="Parcourir les fichiers"
                (click)="triggerChoose($event, doc.key)"
              ></button>
              
              <div class="dropzone-hint">
                PDF, JPG, PNG · Max 10 Mo
              </div>
            </div>

            <div *ngIf="files[doc.key]" class="file-chip">
              <i class="pi pi-file-pdf"></i>
              
              <span class="file-name" [title]="files[doc.key]?.name">
                {{ files[doc.key]?.name }}
              </span>
              
              <div class="file-chip-actions">
                <button
                  type="button"
                  pButton
                  class="p-button-text p-button-sm preview-btn"
                  icon="pi pi-eye"
                  (click)="preview(doc.key)"
                ></button>
                
                <button
                  type="button"
                  pButton
                  class="p-button-text p-button-sm remove-btn"
                  icon="pi pi-times"
                  (click)="clear(doc.key)"
                ></button>
              </div>
            </div>
            
          </ng-template>
        </p-fileUpload>
        
      </p-card>
    </ng-container>
  </div>

  <div class="kyc-actions">
    <button
      pButton
      label="Enregistrer"
      icon="pi pi-check"
      (click)="save()"
      [disabled]="!canSave()"
      class="p-button-success kyc-save-btn"
    ></button>
  </div>
</div>

<p-dialog
  [(visible)]="previewState.visible"
  [modal]="true"
  [style]="{ width: '70vw', maxWidth: '980px' }"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  [draggable]="false"
  [resizable]="false"
  header="Aperçu du document"
  styleClass="preview-dialog"
  (onHide)="closePreview()"
>
  <ng-template pTemplate="header">
    <div class="preview-dialog-header">
      <i class="pi pi-file"></i>
      <span>Aperçu du document</span>
    </div>
  </ng-template>

  <ng-container *ngIf="previewState.type === 'image'">
    <div class="preview-image-wrapper">
      <img 
        [src]="previewState.safeUrl" 
        alt="Aperçu du document" 
        class="preview-image" 
      />
    </div>
  </ng-container>

  <ng-container *ngIf="previewState.type === 'pdf'">
    <div class="preview-pdf-wrapper">
      <iframe
        class="preview-pdf"
        [src]="previewState.safeUrl"
        title="Aperçu PDF"
      ></iframe>
    </div>
  </ng-container>

  <ng-container *ngIf="previewState.type !== 'image' && previewState.type !== 'pdf'">
    <div class="preview-unsupported">
      <i class="pi pi-exclamation-circle"></i>
      <p>Ce type de fichier ne peut pas être prévisualisé.</p>
    </div>
  </ng-container>

  <ng-template pTemplate="footer">
    <button 
      pButton 
      label="Fermer" 
      icon="pi pi-times"
      class="p-button-text" 
      (click)="closePreview()"
    ></button>
  </ng-template>
</p-dialog>